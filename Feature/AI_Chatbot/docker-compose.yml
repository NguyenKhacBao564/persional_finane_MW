version: '3.8'

services:
  chatbot:
    build: .
    image: finance-chatbot:latest
    container_name: finance-chatbot
    env_file:
      - .env
    volumes:
      # Mount data directories for persistence
      - ./database:/app/database:ro
      - ./cleaned_data:/app/cleaned_data
      - ./logs:/app/logs
      # Mount store mapping if exists
      - ./store_mapping.json:/app/store_mapping.json:ro
    environment:
      - PYTHONUNBUFFERED=1
    command: python chatbot.py --list-users
    stdin_open: true
    tty: true

  # Service for data setup
  setup:
    build: .
    image: finance-chatbot:latest
    container_name: finance-chatbot-setup
    env_file:
      - .env
    volumes:
      - ./database:/app/database:ro
      - ./cleaned_data:/app/cleaned_data
      - ./logs:/app/logs
      - ./store_mapping.json:/app/store_mapping.json
    command: >
      sh -c "
      echo 'Step 1: Cleaning data...' &&
      python data_cleaner.py &&
      echo 'Step 2: Setting up Gemini stores...' &&
      python gemini_file_search.py setup &&
      echo 'Setup complete!'
      "
    profiles:
      - setup

  # Service for running demos
  demo:
    build: .
    image: finance-chatbot:latest
    container_name: finance-chatbot-demo
    env_file:
      - .env
    volumes:
      - ./cleaned_data:/app/cleaned_data:ro
      - ./store_mapping.json:/app/store_mapping.json:ro
      - ./logs:/app/logs
    command: python test/chatbot_demo.py --quick
    profiles:
      - demo
